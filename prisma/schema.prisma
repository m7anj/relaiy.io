generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?

  // Gmail OAuth tokens
  gmailAccessToken  String?
  gmailRefreshToken String?
  gmailTokenExpiry  DateTime?

  workers   Worker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Worker {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String       // Natural language description from user

  status      WorkerStatus @default(DRAFT)

  // Current active config
  currentConfigId String?   @unique
  currentConfig   WorkerConfig? @relation("CurrentConfig", fields: [currentConfigId], references: [id])

  // All config versions
  configs     WorkerConfig[] @relation("WorkerConfigs")
  executions  ExecutionLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("workers")
  @@index([userId, status])
}

model WorkerConfig {
  id          String   @id @default(cuid())
  workerId    String
  worker      Worker   @relation("WorkerConfigs", fields: [workerId], references: [id], onDelete: Cascade)

  version     Int      @default(1)

  // Generated configuration (stored as JSON)
  triggers    Json     // Array of trigger objects
  filters     Json     // Array of filter objects
  actions     Json     // Array of action objects

  // Human-readable summary generated by LLM
  summary     String?

  // LLM generation metadata
  llmModel    String?
  llmPrompt   String?  @db.Text
  generatedAt DateTime @default(now())

  // If this is the active config for a worker
  activeForWorker Worker? @relation("CurrentConfig")

  createdAt   DateTime @default(now())

  @@map("worker_configs")
  @@unique([workerId, version])
  @@index([workerId])
}

model ExecutionLog {
  id          String          @id @default(cuid())
  workerId    String
  worker      Worker          @relation(fields: [workerId], references: [id], onDelete: Cascade)

  configVersion Int

  status      ExecutionStatus

  // What emails were affected
  affectedEmails Json         // Array of Gmail message IDs
  emailCount     Int          @default(0)

  // What actions were performed
  actionsPerformed Json       // Array of action objects that were executed

  // Execution details
  executedAt  DateTime        @default(now())
  duration    Int?            // Execution time in ms

  // Error tracking
  error       String?         @db.Text
  errorStack  String?         @db.Text

  // Dry run flag
  isDryRun    Boolean         @default(false)

  @@map("execution_logs")
  @@index([workerId, executedAt])
  @@index([status])
}

enum WorkerStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ExecutionStatus {
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
}
