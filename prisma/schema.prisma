generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?

  // Gmail OAuth tokens
  gmailAccessToken  String?
  gmailRefreshToken String?
  gmailTokenExpiry  DateTime?

  workers   Worker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Worker {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Type & behavior
  type        WorkerType
  information String[]     // additional context for LLM

  // Status tracking
  status               WorkerStatus      @default(DRAFT)
  lastExecutionStatus  ExecutionStatus?

  // Configuration stored as JSON (matches Configuration interface)
  configuration Json

  // Execution tracking
  executionCount   Int       @default(0)
  lastExecutedAt   DateTime?
  nextScheduledAt  DateTime?

  executions  WorkerExecution[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("workers")
  @@index([userId, status])
}

model WorkerExecution {
  id          String          @id @default(cuid())
  workerId    String
  worker      Worker          @relation(fields: [workerId], references: [id], onDelete: Cascade)

  status      ExecutionStatus

  // What emails were affected
  affectedEmails Json         // Array of Gmail message IDs
  emailCount     Int          @default(0)

  // What actions were performed
  actionsPerformed Json       // Array of action objects that were executed

  // Execution details
  executedAt  DateTime        @default(now())
  duration    Int?            // Execution time in ms

  // Error tracking
  error       String?         @db.Text
  errorStack  String?         @db.Text

  // Dry run flag
  isDryRun    Boolean         @default(false)

  @@map("worker_executions")
  @@index([workerId, executedAt])
  @@index([status])
}

enum WorkerType {
  OUTREACH
  NURTURE
  RESPONDER
  DIGEST
}

enum WorkerStatus {
  DRAFT
  ACTIVE
  PAUSED
  STOPPED
}

enum ExecutionStatus {
  SUCCESS
  ERROR
  RUNNING
}
